const streams=require("../node/streams_wasm");async function main(){let e="https://chrysalis-nodes.iota.org/",o=new streams.SendOptions(e,!0);const n=await(new streams.ClientBuilder).node(e).build();let s=B(81),l=streams.Author.fromClient(streams.StreamsClient.fromClient(n),s,streams.ChannelType.SingleBranch);console.log("channel address: ",l.channel_address()),console.log("multi branching: ",l.is_multi_branching()),console.log("IOTA client info:",await n.getInfo());let t=await l.clone().send_announce(),a=t.link;console.log("announced at: ",a.toString()),console.log("Announce message index: "+a.toMsgIndexHex());let c=await l.clone().get_client().get_link_details(a);console.log("Announce message id: "+c.get_metadata().message_id);let r=B(81),i=new streams.Subscriber(r,o.clone());await i.clone().receive_announcement(a.copy());let g=i.author_public_key();console.log("Channel registered by subscriber, author's public key: ",g);let u=i.fetch_state();console.log("Subscribing..."),t=await i.clone().send_subscribe(a.copy());let d=t.link;console.log("Subscription message at: ",d.toString()),console.log("Subscription message index: "+d.toMsgIndexHex()),await l.clone().receive_subscribe(d.copy()),console.log("Subscription processed"),console.log("Sending Keyload"),t=await l.clone().send_keyload_for_everyone(a.copy());let b=t.link;console.log("Keyload message at: ",b.toString()),console.log("Keyload message index: "+b.toMsgIndexHex()),console.log("Subscriber syncing..."),await i.clone().sync_state();let m=q("Public"),h=q("Masked");console.log("Subscriber Sending tagged packet"),t=await i.clone().send_tagged_packet(b,m,h);let _=t.link;console.log("Tag packet at: ",_.toString()),console.log("Tag packet index: "+_.toMsgIndexHex());let p=_;console.log("Subscriber Sending multiple signed packets");for(var f=0;f<10;f++)t=await i.clone().send_signed_packet(p,m,h),p=t.link,console.log("Signed packet at: ",p.toString()),console.log("Signed packet index: "+p.toMsgIndexHex());console.log("\nAuthor fetching next messages");let y=!0;for(;y;){let e=await l.clone().fetch_next_msgs();0===e.length&&(y=!1);for(var k=0;k<e.length;k++)console.log("Found a message..."),console.log("Public: ",N(e[k].message.get_public_payload()),"\tMasked: ",N(e[k].message.get_masked_payload()))}console.log("\nSubscriber resetting state"),i.clone().reset_state();let S=i.fetch_state();var w=!0;for(k=0;k<S.length;k++)u[k].link.toString()==S[k].link.toString()&&u[k].seqNo==S[k].seqNo&&u[k].branchNo==S[k].branchNo||(w=!1);w?console.log("States match"):console.log("States do not match"),console.log("\nAuthor fetching prev messages");let x=await l.clone().fetch_prev_msgs(p,3);for(var v=0;v<x.length;v++)console.log("Found a message at ",x[v].link.toString()),console.log("Found a message at index: "+x[v].link.toMsgIndexHex());console.log("\nExporting and importing state");let A="password",C=l.clone().export(A),M=new streams.StreamsClient(e,o.clone());streams.Author.import(M,C,A).channel_address!==l.channel_address?console.log("import failed"):console.log("import succesfull"),console.log("\nRecovering without state import"),(await streams.Author.recover(s,a.copy(),streams.ChannelType.SingleBranch,o.clone())).channel_address!==l.channel_address?console.log("recovery failed"):console.log("recovery succesfull"),console.log("\nSub sending unsubscribe message"),t=await i.clone().send_unsubscribe(d),await l.clone().receive_unsubscribe(t.link),console.log("Author received unsubscribe and processed it"),console.log("\nAuthor sending new keyload to all subscribers"),t=await l.clone().send_keyload_for_everyone(a.copy()),await i.receive_keyload(t.link)?console.log("unsubscription unsuccessful"):console.log("unsubscription successful");let I=B(81),H=new streams.Subscriber(I,o.clone());await H.clone().receive_announcement(a.copy());let T=H.get_public_key();function q(e){for(var o=[],n=0;n<e.length;++n)o.push(e.charCodeAt(n));return o}function N(e){for(var o="",n=0;n<e.length;++n)o+=String.fromCharCode(e[n]);return o}function B(e){const o="abcdefghijklmnopqrstuvwxyz";let n="";for(k=9;k<e;k++)n+=o[Math.floor(Math.random()*o.length)];return n}l.clone().store_new_subscriber(T),console.log("\nAuthor manually subscribed sub 2"),l.clone().remove_subscriber(T),console.log("Author manually unsubscribed sub 2")}streams.set_panic_hook(),main().then((()=>{console.log("Done example")})).catch((e=>{console.log(e)}));